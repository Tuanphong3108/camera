<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chụp Ảnh & Quay Video PWA</title>
    <link rel="manifest" href="manifest.json" />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
      
      :root {
        --color-primary: #007bff;
        --color-primary-dark: #0056b3;
        --color-background: #111;
        --color-text-light: #f4f4f4;
        --color-text-dark: #333;
        --border-radius: 12px;
      }
      
      body {
        font-family: 'Inter', sans-serif;
        background-color: var(--color-background);
        color: var(--color-text-light);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 1rem;
        box-sizing: border-box;
      }
      
      #app {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        max-width: 600px;
        height: 100%;
        max-height: 80vh;
        background-color: #1a1a1a;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        padding: 1rem;
        box-sizing: border-box;
        position: relative;
        overflow: hidden;
      }

      .setup-screen {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 2rem;
        animation: fadeIn 0.5s ease-in-out;
      }
      
      .setup-screen h1 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
      }
      
      .setup-screen p {
        font-size: 1rem;
        color: #aaa;
        margin-bottom: 2rem;
      }
      
      .setup-screen .btn {
        width: 100%;
        max-width: 250px;
        margin-bottom: 1rem;
      }

      .camera-container {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #000;
        border-radius: var(--border-radius);
        overflow: hidden;
      }

      video, canvas, .preview-container {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
      }
      
      .preview-container {
        display: none;
        position: relative;
      }

      .preview-container .preview-buttons {
        position: absolute;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 1rem;
      }

      .preview-container .preview-buttons .btn {
        width: 100px;
      }

      .controls {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        gap: 1rem;
        padding: 1rem 0;
        box-sizing: border-box;
      }

      .controls .btn {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        font-size: 1.5rem;
        transition: transform 0.2s;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      
      .controls .btn:hover {
        transform: scale(1.1);
      }
      
      .controls .btn-mode {
        width: 40px;
        height: 40px;
        background-color: #333;
        border: 2px solid #555;
        font-size: 0.8rem;
        border-radius: var(--border-radius);
        transition: transform 0.2s;
      }
      
      .controls .btn-mode.active {
        border-color: var(--color-primary);
        color: var(--color-primary);
      }

      .btn {
        background-color: var(--color-primary);
        color: var(--color-text-light);
        border: none;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        border-radius: var(--border-radius);
        transition: background-color 0.3s, transform 0.3s;
      }
      
      .btn:hover {
        background-color: var(--color-primary-dark);
      }

      .status-message {
        position: absolute;
        top: 2rem;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        padding: 0.75rem 1.5rem;
        border-radius: var(--border-radius);
        color: #fff;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        z-index: 10;
        font-size: 0.9rem;
      }

      .status-message.visible {
        opacity: 1;
      }

      .hidden {
        display: none !important;
      }

      .video-player-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: rgba(0, 0, 0, 0.7);
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        cursor: pointer;
      }

      .video-player-overlay .play-btn {
        width: 60px;
        height: 60px;
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 1.5rem;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: transform 0.2s;
      }
      
      .video-player-overlay .play-btn:hover {
        transform: scale(1.1);
      }
      
      .video-player-overlay.visible {
        opacity: 1;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      @media (max-width: 600px) {
        #app {
          padding: 0.5rem;
          max-height: 95vh;
        }
        .setup-screen {
          padding: 1rem;
        }
        .setup-screen h1 {
          font-size: 1.5rem;
        }
        .setup-screen p {
          font-size: 0.9rem;
        }
        .preview-container .preview-buttons {
          bottom: 1rem;
        }
        .controls .btn {
          width: 60px;
          height: 60px;
          font-size: 1.2rem;
        }
        .controls .btn-mode {
          width: 30px;
          height: 30px;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="setup-screen" class="setup-screen">
        <h1>Chào mừng!</h1>
        <p>Đây là một ứng dụng camera PWA. Bạn có thể cài đặt và sử dụng nó như một ứng dụng bình thường. Để có trải nghiệm tốt nhất, vui lòng thiết lập quyền truy cập.</p>
        <button id="setup-now-btn" class="btn">Thiết lập ngay</button>
        <button id="setup-later-btn" class="btn">Để sau</button>
      </div>

      <div id="camera-app" class="hidden">
        <div class="camera-container">
          <video id="video-stream" autoplay playsinline></video>
          <canvas id="camera-canvas" class="hidden"></canvas>
          <div id="preview-container" class="preview-container hidden">
            <video id="recorded-video" class="hidden"></video>
            <div id="video-player-overlay" class="video-player-overlay hidden">
              <button class="play-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24px" height="24px">
                  <path d="M8 5v14l11-7z" />
                </svg>
              </button>
            </div>
            <div class="preview-buttons">
              <button id="download-btn" class="btn">Tải xuống</button>
              <button id="retake-btn" class="btn">Chụp lại</button>
            </div>
          </div>
        </div>
        <div class="controls">
          <div id="mode-buttons-container">
            <button id="photo-mode-btn" class="btn btn-mode active">Ảnh</button>
            <button id="video-mode-btn" class="btn btn-mode">Video</button>
          </div>
          <button id="capture-btn" class="btn">
            <svg id="photo-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="36px" height="36px">
              <path d="M0 0h24v24H0z" fill="none" />
              <path d="M12 10.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm6 4.5c0 1.1-.9 2-2 2H8c-1.1 0-2-.9-2-2v-4c0-1.1.9-2 2-2h1.17l.83-1h4l.83 1H16c1.1 0 2 .9 2 2v4zM20 9c0-.55-.45-1-1-1h-2.17l-1-2H8.17l-1 2H5c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1h14c.55 0 1-.45 1-1V9z" />
            </svg>
            <svg id="video-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="36px" height="36px">
              <path d="M0 0h24v24H0z" fill="none" />
              <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z" />
            </svg>
          </button>
          <button id="toggle-camera-btn" class="btn btn-mode">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24px" height="24px">
              <path d="M0 0h24v24H0z" fill="none" />
              <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5-3c0 2.76-2.24 5-5 5s-5-2.24-5-5h-1c0 3.19 2.61 5.76 5.92 5.94V21h2.08v-4.06c3.31-.18 5.92-2.75 5.92-5.94h-1z" />
            </svg>
          </button>
        </div>
      </div>
      
      <div id="status-message" class="status-message hidden"></div>
    </div>

    <script>
      let videoStream;
      let isFacingUser = true;
      let mediaRecorder;
      let recordedChunks = [];
      let isRecording = false;
      let currentMode = 'photo'; // 'photo' or 'video'

      // DOM elements
      const app = document.getElementById('app');
      const setupScreen = document.getElementById('setup-screen');
      const cameraApp = document.getElementById('camera-app');
      const videoElement = document.getElementById('video-stream');
      const canvasElement = document.getElementById('camera-canvas');
      const previewContainer = document.getElementById('preview-container');
      const recordedVideoElement = document.getElementById('recorded-video');
      const captureButton = document.getElementById('capture-btn');
      const downloadButton = document.getElementById('download-btn');
      const retakeButton = document.getElementById('retake-btn');
      const toggleCameraButton = document.getElementById('toggle-camera-btn');
      const photoModeBtn = document.getElementById('photo-mode-btn');
      const videoModeBtn = document.getElementById('video-mode-btn');
      const modeButtonsContainer = document.getElementById('mode-buttons-container');
      const photoIcon = document.getElementById('photo-icon');
      const videoIcon = document.getElementById('video-icon');
      const statusMessage = document.getElementById('status-message');
      const setupNowBtn = document.getElementById('setup-now-btn');
      const setupLaterBtn = document.getElementById('setup-later-btn');
      const videoPlayerOverlay = document.getElementById('video-player-overlay');
      const videoPlayBtn = videoPlayerOverlay.querySelector('.play-btn');

      const showStatus = (message) => {
        statusMessage.textContent = message;
        statusMessage.classList.remove('hidden');
        statusMessage.classList.add('visible');
        setTimeout(() => {
          statusMessage.classList.remove('visible');
          setTimeout(() => {
            statusMessage.classList.add('hidden');
          }, 500);
        }, 3000);
      };

      const requestFileAccess = async () => {
        try {
          const directoryHandle = await window.showDirectoryPicker();
          return directoryHandle;
        } catch (error) {
          if (error.name === 'NotAllowedError' || error.name === 'SecurityError') {
            console.warn('Quyền truy cập tệp bị từ chối.');
            showStatus('Quyền truy cập tệp bị từ chối. File sẽ được tải về.');
            return null;
          }
          console.error('Lỗi khi truy cập hệ thống tệp:', error);
          showStatus('Lỗi truy cập. File sẽ được tải về.');
          return null;
        }
      };

      const initializeCamera = async (isFacingUser) => {
        if (videoStream) {
          videoStream.getTracks().forEach(track => track.stop());
        }

        const constraints = {
          video: { facingMode: isFacingUser ? 'user' : 'environment' },
          audio: { deviceId: 'default' }
        };

        try {
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          videoElement.srcObject = stream;
          videoStream = stream;
          videoElement.play();
          videoElement.classList.remove('hidden');
          canvasElement.classList.add('hidden');
          previewContainer.classList.add('hidden');
          cameraApp.classList.remove('hidden');
          setupScreen.classList.add('hidden');
        } catch (error) {
          showStatus('Lỗi: Không thể truy cập camera. Vui lòng cấp quyền.');
          console.error('Lỗi truy cập camera:', error);
        }
      };

      const capturePhoto = () => {
        const context = canvasElement.getContext('2d');
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
        context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

        videoElement.classList.add('hidden');
        canvasElement.classList.remove('hidden');
        previewContainer.classList.remove('hidden');
        modeButtonsContainer.classList.add('hidden');
        captureButton.classList.add('hidden');

        downloadButton.textContent = 'Lưu ảnh';
        downloadButton.onclick = async () => {
          const dataUrl = canvasElement.toDataURL('image/png');
          const blob = await (await fetch(dataUrl)).blob();
          const fileName = `photo-${new Date().toISOString()}.png`;
          await saveFile(blob, fileName);
          retakePhotoOrVideo();
        };
      };

      const startVideoRecording = () => {
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(videoStream);

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            recordedChunks.push(event.data);
          }
        };

        mediaRecorder.onstop = () => {
          const videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
          const videoUrl = URL.createObjectURL(videoBlob);
          recordedVideoElement.src = videoUrl;
          recordedVideoElement.classList.remove('hidden');
          recordedVideoElement.play();
          
          videoPlayerOverlay.classList.remove('hidden');
          updatePlayButtonIcon(false);

          videoElement.classList.add('hidden');
          previewContainer.classList.remove('hidden');
          modeButtonsContainer.classList.add('hidden');
          captureButton.classList.add('hidden');

          downloadButton.textContent = 'Lưu video';
          downloadButton.onclick = async () => {
            const fileName = `video-${new Date().toISOString()}.webm`;
            await saveFile(videoBlob, fileName);
            retakePhotoOrVideo();
          };
        };

        mediaRecorder.start();
        isRecording = true;
        captureButton.style.backgroundColor = 'red';
        captureButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="36px" height="36px"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 2c5.52 0 10 4.48 10 10s-4.48 10-10 10S2 17.52 2 12 6.48 2 12 2zm-2 14H8V8h2v8zm4 0h-2V8h2v8z"/></svg>`;
      };

      const stopVideoRecording = () => {
        mediaRecorder.stop();
        isRecording = false;
        captureButton.style.backgroundColor = 'var(--color-primary)';
        captureButton.innerHTML = `<svg id="video-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="36px" height="36px"><path d="M0 0h24v24H0z" fill="none" /><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z" /></svg>`;
      };

      const retakePhotoOrVideo = () => {
        videoElement.classList.remove('hidden');
        canvasElement.classList.add('hidden');
        previewContainer.classList.add('hidden');
        recordedVideoElement.classList.add('hidden');
        modeButtonsContainer.classList.remove('hidden');
        captureButton.classList.remove('hidden');
        videoPlayerOverlay.classList.add('hidden');
        if (recordedVideoElement.src) {
            URL.revokeObjectURL(recordedVideoElement.src);
            recordedVideoElement.src = '';
        }
      };

      const saveFile = async (blob, fileName) => {
        // Cố gắng sử dụng File System Access API
        try {
            const directoryHandle = await window.showDirectoryPicker();
            const fileHandle = await directoryHandle.getFileHandle(fileName, { create: true });
            const writableStream = await fileHandle.createWritable();
            await writableStream.write(blob);
            await writableStream.close();
            showStatus(`Đã lưu "${fileName}" vào thư mục bạn chọn!`);
        } catch (error) {
            console.error('Lỗi khi lưu tệp, chuyển sang chế độ tải xuống:', error);
            // Fallback: nếu API không khả dụng hoặc bị từ chối
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showStatus('Đã tải xuống file!');
        }
      };
      
      const updatePlayButtonIcon = (isPlaying) => {
        const iconSvg = isPlaying
          ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24px" height="24px"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`
          : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24px" height="24px"><path d="M8 5v14l11-7z"/></svg>`;
        videoPlayBtn.innerHTML = iconSvg;
      };

      videoPlayBtn.addEventListener('click', () => {
        if (recordedVideoElement.paused || recordedVideoElement.ended) {
          recordedVideoElement.play();
          updatePlayButtonIcon(true);
        } else {
          recordedVideoElement.pause();
          updatePlayButtonIcon(false);
        }
      });
      
      recordedVideoElement.addEventListener('play', () => {
          videoPlayerOverlay.classList.add('hidden');
      });
      
      recordedVideoElement.addEventListener('pause', () => {
          videoPlayerOverlay.classList.remove('hidden');
      });
      
      recordedVideoElement.addEventListener('ended', () => {
          videoPlayerOverlay.classList.remove('hidden');
          updatePlayButtonIcon(false);
      });
      
      setupNowBtn.addEventListener('click', async () => {
        // Yêu cầu quyền truy cập thư mục ngay lập tức
        const directoryHandle = await requestFileAccess();
        if (directoryHandle) {
          showStatus('Đã thiết lập quyền. Giờ bạn có thể lưu file trực tiếp.');
        } else {
          showStatus('Thiết lập quyền thất bại. File sẽ được tải về.');
        }
        initializeCamera(true);
      });

      setupLaterBtn.addEventListener('click', () => {
        initializeCamera(true);
      });

      captureButton.addEventListener('click', () => {
        if (currentMode === 'photo') {
          capturePhoto();
        } else {
          if (isRecording) {
            stopVideoRecording();
          } else {
            startVideoRecording();
          }
        }
      });

      retakeButton.addEventListener('click', retakePhotoOrVideo);

      toggleCameraButton.addEventListener('click', () => {
        isFacingUser = !isFacingUser;
        initializeCamera(isFacingUser);
      });

      photoModeBtn.addEventListener('click', () => {
        currentMode = 'photo';
        photoModeBtn.classList.add('active');
        videoModeBtn.classList.remove('active');
        photoIcon.classList.remove('hidden');
        videoIcon.classList.add('hidden');
        if (isRecording) {
            stopVideoRecording();
        }
      });

      videoModeBtn.addEventListener('click', () => {
        currentMode = 'video';
        videoModeBtn.classList.add('active');
        photoModeBtn.classList.remove('active');
        videoIcon.classList.remove('hidden');
        photoIcon.classList.add('hidden');
      });

      window.addEventListener('load', () => {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('service-worker.js').then(
            (registration) => {
              console.log('Service Worker đã được đăng ký:', registration);
            },
            (error) => {
              console.error('Đăng ký Service Worker thất bại:', error);
            }
          );
        }
      });
    </script>
  </body>
</html>
